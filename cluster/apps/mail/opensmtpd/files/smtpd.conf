# PKI-Konfiguration
pki "mail" cert "/certs/tls.crt"
pki "mail" key "/certs/tls.key"

# Tabellen für PostgreSQL
table domains postgres:/etc/smtpd/postgres.conf
table credentials postgres:/etc/smtpd/postgres.conf
table virtuals postgres:/etc/smtpd/postgres.conf

filter check_dyndns phase connect match rdns regex { '.*\.dyn\..*', '.*\.dsl\..*' } \
    disconnect "550 no residential connections - Thou shalt not pass"

filter check_rdns phase connect match !rdns \
    disconnect "550 no rdns - Thou shalt not pass"

filter check_fcrdns phase connect match !fcrdns \
    disconnect "550 no FCrDNS - Thou shalt not pass"

filter rspamd proc-exec "/usr/lib/opensmtpd/filter-rspamd --url http://mailserver-rspamd:11333"

# Listener
listen on 0.0.0.0 port 25 tls pki mail hostname terra.rwcloud.org filter { check_dyndns, check_rdns, check_fcrdns, rspamd }
listen on :: port 25 tls pki mail hostname terra.rwcloud.org filter { check_dyndns, check_rdns, check_fcrdns, rspamd }
listen on 0.0.0.0 port 587 tls-require pki mail hostname terra.rwcloud.org auth <credentials>
listen on :: port 587 tls-require pki mail hostname terra.rwcloud.org auth <credentials>

# OHNE virtual aliases!
action "domain_mail" lmtp "mailserver-dovecot:24" rcpt-to virtual <virtuals>
action "outbound" relay

# NUR Domain-Check, KEINE Alias-Auflösung
match from any for domain <domains> action "domain_mail"
match from local for any action "outbound"