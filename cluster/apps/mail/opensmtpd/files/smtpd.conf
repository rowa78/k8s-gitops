# PKI-Konfiguration
pki "mail" cert "/certs/tls.crt"
pki "mail" key "/certs/tls.key"

# Tabellen für PostgreSQL
table domains postgres:/etc/smtpd/postgres.conf
table credentials postgres:/etc/smtpd/postgres.conf
table userinfo postgres:/etc/smtpd/postgres.conf
table aliases postgres:/etc/smtpd/postgres.conf

# Listener konfigurieren
# Port 25 für eingehende Mails
listen on 0.0.0.0 port 25 tls pki mail hostname terra.rwcloud.org
listen on :: port 25 tls pki mail hostname terra.rwcloud.org

# Port 587 für authentifizierte Clients (Submission)
listen on 0.0.0.0 port 587 tls-require pki mail hostname terra.rwcloud.org auth <credentials>
listen on :: port 587 tls-require pki mail hostname terra.rwcloud.org auth <credentials>

# Optional: Port 465 für SMTPS
# listen on 0.0.0.0 port 465 smtps pki mail hostname terra.rwcloud.org auth <credentials>
# listen on :: port 465 smtps pki mail hostname terra.rwcloud.org auth <credentials>

# Aktionen definieren
action "domain_mail" lmtp "mailserver-dovecot:24" rcpt-to virtual <aliases>
action "outbound" relay

# Regeln für Mail-Routing
# Eingehende Mails für lokale Domains mit Alias-Unterstützung
match from any for domain <domains> action "domain_mail"

# Ausgehende Mails von authentifizierten Benutzern
match from any auth for any action "outbound"

# Optional: Lokale Mails
match from local for any action "outbound"